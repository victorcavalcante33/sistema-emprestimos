{% extends 'base.html' %}
{% load custom_filters %}
{% block title %}Totais Gerais{% endblock %}

{% block content %}
<div class="container">
    <h2 class="mb-4 text-primary"></h2>

    <!-- Botão para abrir o modal de filtros -->
    <div class="d-flex mb-3">
        <button class="btn btn-primary me-2" type="button" data-bs-toggle="modal" data-bs-target="#filtrosModal">
            Filtros
        </button>
        <form method="GET" id="filterTodayForm" class="ms-2">
            <input type="hidden" name="data_inicio" value="{{ data_hoje }}">
            <input type="hidden" name="data_fim" value="{{ request.GET.data_fim }}">
            <button type="submit" class="btn btn-secondary">Hoje</button>
        </form>
    </div>

    <!-- Modal de Filtros -->
    <div class="modal fade" id="filtrosModal" tabindex="-1" aria-labelledby="filtrosModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Filtros</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form method="GET" id="filterForm">
                        <div class="container-fluid">
                            <div class="row justify-content-center">
                                <div class="col-12 col-md-10">
                                    <div class="row g-3">
                                        {% if admin_view %}
                                        <div class="col-12">
                                            <select name="grupo" class="form-select form-select-sm">
                                                <option value="">Todos os Grupos</option>
                                                {% for grupo in grupos %}
                                                    <option value="{{ grupo.name }}" {% if grupo.name == request.GET.grupo %}selected{% endif %}>{{ grupo.name }}</option>
                                                {% endfor %}
                                            </select>
                                        </div>                        
                                        <div class="col-12">
                                            <select name="usuario" class="form-select form-select-sm">
                                                <option value="">Todos os Usuários</option>
                                                {% for usuario in usuarios %}
                                                    <option value="{{ usuario.username }}" {% if usuario.username == request.GET.usuario %}selected{% endif %}>{{ usuario.username }}</option>
                                                {% endfor %}
                                            </select>
                                        </div>                        
                                        {% endif %}
                                        <div class="col-12">
                                            <label for="data_inicio" class="form-label">Data Início:</label>
                                            <input type="date" name="data_inicio" id="data_inicio" class="form-control form-control-sm" value="{{ data_inicio|default:'' }}">
                                        </div>
                                        <div class="col-12">
                                            <label for="data_fim" class="form-label">Data Fim:</label>
                                            <input type="date" name="data_fim" id="data_fim" class="form-control form-control-sm" value="{{ data_fim|default:'' }}">
                                        </div>
                                        
                                    </div>
                                    <div class="d-flex justify-content-center mt-4">
                                        <button type="submit" class="btn btn-primary mx-2">Aplicar</button>
                                        <button type="button" class="btn btn-secondary mx-2" onclick="limparFiltros()">Limpar</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
    <!-- Exibição dos Totais de Atrasos -->
    <div class="d-flex justify-content-around mb-4">
        <div class="rounded-circle bg-warning d-flex align-items-center justify-content-center" style="width: 70px; height: 70px;" >
            <span class="text-white fw-bold">{{ total_amarelo }}</span>
        </div>
        <div class="rounded-circle bg-danger d-flex align-items-center justify-content-center" style="width: 70px; height: 70px;">
            <span class="text-white fw-bold">{{ total_vermelho }}</span>
        </div>
    </div>
    <!-- Exibição dos Totais de Valores -->
    <div class="table-responsive mb-4">
        <table class="table table-bordered table-hover">
            <thead class="table-light">
                <tr>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>Total Saída</td>
                    <td class="text-end fw-bold" id="total-investido">{{ totais_financeiros.total_capital|default:'0'|floatformat:0 }}</td>
                </tr>
                <tr>
                    <td>Total Entrada</td>
                    <td class="text-end fw-bold" id="total-entrada">
                        <div class="text-center mb-2">
                            <strong class="mb-2 text-primary">PIX: </strong>
                            <span class="valor-pago">{{ total_pix|floatformat:0 }}</span>
                            <br>
                            <strong class="mb-2 text-primary">Dinheiro: </strong>
                            <span class="valor-pago">{{ total_dinheiro|floatformat:0 }}</span>
                            <br>
                            <strong class="mb-2 text-primary">Total: </strong>
                            <span class="valor-pago">{{ total_pagamentos|floatformat:0 }}</span>
                        </div>
                    </td>
                </tr>
                <tr>
                    <td>Lucro</td>
                    <td class="text-end fw-bold">{{ total_juros_recebidos|floatformat:0 }}</td>
                </tr>
            </tbody>
        </table>
    </div>



    <!-- Exibição dos Totais de Status -->
    <div class="table-responsive mb-4">
        <table class="table table-bordered table-hover">
            <thead class="table-light">
                <tr>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>Clientes Novos</td>
                    <td class="text-end fw-bold">{{ total_nv }}</td>
                </tr>
                <tr>
                    <td>Inadimplentes</td>
                    <td class="text-end fw-bold" id="total-inadimplentes">{{ total_inadimplentes }}</td>
                </tr>
                <tr>
                    <td>NV</td>
                    <td class="text-end fw-bold">{{ total_geral.total_emprestimos }}</td>
                </tr>
                <tr>
                    <td>NG</td>
                    <td class="text-end fw-bold" id="total-ng">{{ total_ng }}</td>
                </tr>
                <tr>
                    <td>R</td>
                    <td class="text-end fw-bold" id="total-r">{{ total_r }}</td>
                </tr>
                <tr>
                    <td>AC</td>
                    <td class="text-end fw-bold" id="total-ac">{{ total_ac }}</td>
                </tr>
            </tbody>
        </table>
    </div>

    <!-- Tabela de Detalhes -->
    <div class="table-responsive">
        <table class="table table-striped">
            <thead>
                <tr>
                    <th>Status</th>
                    <th>Cliente</th>
                    <th>Contrato</th>
                    <th>Total Saldo</th>
                    <th>Saída (Capital)</th>
                    <th>Juros</th>
                    <th>Total Pago</th>
                    <th>Tipo de Pagamento</th>
                    <th>Grupo</th>
                    <th>Usuário</th>
                </tr>
            </thead>
            <tbody class="align-middle text-center"> 
                {% for emprestimo in emprestimos %}
                <tr>
                    <td>
                        {% if emprestimo.status == 'ativo' %}
                            NV
                        {% elif emprestimo.status == 'finalizado' %}
                            AC
                        {% elif emprestimo.status == 'R' %}
                            R
                            {% elif emprestimo.status == 'NG' %}
                            NG
                        {% else %}
                            {{ emprestimo.status }}
                        {% endif %}
                    </td>
                    <td>{{ emprestimo.cliente.apelido }}<div class="small">{{ emprestimo.cliente.nome }}</div></td>
                                <td>{{ emprestimo.id }}</td>
                                <td>{{ emprestimo.saldo_devedor|floatformat:0 }}</td>
                                <td>{{ emprestimo.capital }}</td>
                                <td>{{ emprestimo.calcular_valor_juros|floatformat:0 }}</td>
                                <td>
                                    {% for pagamento in emprestimo.pagamentos.all %}
                                        {{ pagamento.valor_pago|floatformat:0 }}<br>
                                    {% endfor %}
                                </td>
                                <td>
                                    {% for pagamento in emprestimo.pagamentos.all %}
                                        {{ pagamento.tipo_pagamento }}<br>
                                    {% endfor %}
                                </td>
                                <td>{{ emprestimo.grupo.name }}</td>
                                <td>{{ emprestimo.usuario.username }}</td>
                            </tr>
                        {% endfor %}
            </tbody>
        </table>
    </div>
    <script>
        function limparFiltros() {
            var form = document.getElementById('filterForm');
            var inputs = form.getElementsByTagName('input');
            var selects = form.getElementsByTagName('select');

            for (var i = 0; i < inputs.length; i++) {
                if (inputs[i].type === 'text' || inputs[i].type === 'date') {
                    inputs[i].value = '';
                }
            }

            for (var i = 0; i < selects.length; i++) {
                selects[i].selectedIndex = 0;
            }

            form.submit();
        }
    </script>
</div>
{% endblock %}