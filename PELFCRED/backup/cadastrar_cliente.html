{% extends 'base.html' %}
{% load static %}

{% block title %}Cadastrar Cliente{% endblock %}

{% block content %}
<body class = 'bg-light'>
    <div class="row justify-content-center">
        <div class="col-md-1 col-lg-7">
            <div class="card shadow">
                <div class="card-body">
                    <h4 class="mb-1 text-primary text-center">Cadastrar Cliente</h4> 
                    <form method="post" class="mb-1">
                        {% csrf_token %}
                        <div class="row g-2">
                            <div class="col-12 col-md-4">
                                <div class="form-group">
                                    {{ form.nome.label_tag }}
                                    {{ form.nome}}
                                    {% if form.nome.errors %}
                                    <div class="error-message">{{ form.nome.errors }}</div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-12 col-md-4">
                                <div class="form-group">
                                    {{ form.apelido.label_tag }}
                                    {{ form.apelido }}
                                    {% if form.apelido.errors %}
                                    <div class="error-message">{{ form.apelido.errors }}</div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-12 col-md-4">
                                <div class="form-group">
                                    {{ form.cpf.label_tag }}
                                    <input type="text" name="{{ form.cpf.name }}" id="{{ form.cpf.auto_id }}" class="form-control" maxlength="11" oninput="this.value = this.value.replace(/[^0-9]/g, '')">
                                    {% if form.cpf.errors %}
                                    <div class="error-message">{{ form.cpf.errors }}</div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-12 col-md-4">
                                <div class="form-group">
                                    {{ form.cnpj.label_tag }}
                                    {{ form.cnpj }}
                                    {% if form.cnpj.errors %}
                                    <div class="error-message">{{ form.cnpj.errors }}</div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-12 col-md-4">
                                <div class="form-group">
                                    {{ form.documento.label_tag }}
                                    {{ form.documento }}
                                    {% if form.documento.errors %}
                                    <div class="error-message">{{ form.documento.errors }}</div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-12 col-md-4">
                                <div class="form-group">
                                    {{ form.email.label_tag }}
                                    {{ form.email }}
                                    {% if form.email.errors %}
                                    <div class="error-message">{{ form.email.errors }}</div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-12 col-md-3">
                                <div class="form-group">
                                    {{ form.telefone.label_tag }}
                                    {{ form.telefone }}
                                    {% if form.telefone.errors %}
                                    <div class="error-message">{{ form.telefone.errors }}</div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-12 col-md-3">
                                <div class="form-group">
                                    {{ form.telefone2.label_tag }}
                                    {{ form.telefone2 }}
                                    {% if form.telefone2.errors %}
                                    <div class="error-message">{{ form.telefone2.errors }}</div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-12 col-md-3">
                                <div class="form-group">
                                    {{ form.vinculo_telefone2.label_tag }}
                                    {{ form.vinculo_telefone2 }}
                                    {% if form.vinculo_telefone2.errors %}
                                    <div class="error-message">{{ form.vinculo_telefone2.errors }}</div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-12 col-md-3">
                                <div class="form-group">
                                    {{ form.cep.label_tag }}
                                    {{ form.cep }}
                                    {% if form.cep.errors %}
                                    <div class="error-message">{{ form.cep.errors }}</div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-12 col-md-6">
                                <div class="form-group">
                                    {{ form.endereco.label_tag }}
                                    {{ form.endereco }}
                                    {% if form.endereco.errors %}
                                    <div class="error-message">{{ form.endereco.errors }}</div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-12 col-md-3">
                                <div class="form-group">
                                    {{ form.numero_endereco.label_tag }}
                                    {{ form.numero_endereco }}
                                    {% if form.numero_endereco.errors %}
                                    <div class="error-message">{{ form.numero_endereco.errors }}</div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-12 col-md-3">
                                <div class="form-group">
                                    {{ form.uf.label_tag }}
                                    {{ form.uf }}
                                    {% if form.uf.errors %}
                                    <div class="error-message">{{ form.uf.errors }}</div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-12 col-md-4">
                                <div class="form-group">
                                    {{ form.cidade.label_tag }}
                                    {{ form.cidade }}
                                    {% if form.cidade.errors %}
                                    <div class="error-message">{{ form.cidade.errors }}</div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-12 col-md-4">
                                <div class="form-group">
                                    {{ form.bairro.label_tag }}
                                    {{ form.bairro }}
                                    {% if form.bairro.errors %}
                                    <div class="error-message">{{ form.bairro.errors }}</div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-12 col-md-4">
                                <div class="form-group">
                                    {{ form.complemento.label_tag }}
                                    {{ form.complemento }}
                                    {% if form.complemento.errors %}
                                    <div class="error-message">{{ form.complemento.errors }}</div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        <div class="form-group mt-3 text-center">
                            <button type="submit" class="btn btn-primary">Cadastrar Cliente</button>
                            <a href="{% url 'PELFCRED:lista_clientes' %}" class="btn btn-secondary">Cancelar</a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

<style>
    .form-group {
        margin-bottom: 0.0rem;
    }
    .form-group label {
        font-weight: bold;
        font-size: 0.55em;
    }
    .form-group input,
    .form-group select {
        font-size: 0.45em;
        padding: 0.10rem 0.2rem;
        height: auto;
    }
    .error-message {
        color: red;
        font-size: 0.65em;
        margin-top: 0.2rem;
    }
    .alert {
        padding: 0.75rem 1.25rem;
        margin-bottom: 1rem;
        border: 1px solid transparent;
        border-radius: 0.25rem;
    }
    .alert-danger {
        color: #721c24;
        background-color: #f8d7da;
        border-color: #f5c6cb;
    }
</style>

<script>
document.addEventListener("DOMContentLoaded", function() {
    const cepInput = document.getElementById('id_cep');
    const vinculoSelect = document.getElementById('id_vinculo_telefone2');
    const cpfInput = document.getElementById('id_cpf');

    cepInput.addEventListener('blur', function() {
        const cep = this.value.replace(/\D/g, '');
        if (cep.length === 8) {
            fetch(`https://viacep.com.br/ws/${cep}/json/`)
                .then(response => response.json())
                .then(data => {
                    if (!data.erro) {
                        document.getElementById('id_endereco').value = data.logradouro || "";
                        document.getElementById('id_bairro').value = data.bairro || "";
                        document.getElementById('id_cidade').value = data.localidade || "";
                        document.getElementById('id_uf').value = data.uf || "";
                    } else {
                        alert("CEP não encontrado.");
                    }
                })
                .catch(error => console.error("Erro ao buscar CEP:", error));
        }
    });

    vinculoSelect.addEventListener('change', function() {
        const vinculoOutro = document.getElementById('id_vinculo_outro');
        vinculoOutro.style.display = this.value === 'Outro' ? 'block' : 'none';
        if (this.value !== 'Outro') vinculoOutro.value = '';
    });

    cpfInput.addEventListener('blur', function() {
        const cpf = this.value.replace(/\D/g, '');
        if (cpf.length === 11) {
            if (validarCPF(cpf)) {
                this.setCustomValidity('');
            } else {
                this.setCustomValidity('CPF inválido');
                alert('CPF inválido');
            }
        }
    });

    function validarCPF(cpf) {
        if (cpf.length !== 11) return false;
        if (/^(\d)\1+$/.test(cpf)) return false;

        let soma = 0;
        for (let i = 0; i < 9; i++) {
            soma += parseInt(cpf.charAt(i)) * (10 - i);
        }
        let resto = 11 - (soma % 11);
        let digitoVerificador1 = resto === 10 || resto === 11 ? 0 : resto;

        soma = 0;
        for (let i = 0; i < 10; i++) {
            soma += parseInt(cpf.charAt(i)) * (11 - i);
        }
        resto = 11 - (soma % 11);
        let digitoVerificador2 = resto === 10 || resto === 11 ? 0 : resto;

        return digitoVerificador1 === parseInt(cpf.charAt(9)) && digitoVerificador2 === parseInt(cpf.charAt(10));
    }
});
</script>
{% endblock %}